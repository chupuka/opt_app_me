@model ProForm.Models.FitnessClass
@{
    ViewData["Title"] = "Детали занятия";
}

<div class="container-fluid">
    <h1>Детали занятия</h1>
    <hr />

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Тип занятия:</dt>
                        <dd class="col-sm-8">@(Model.Type == ClassType.Group ? "Групповое" : "Персональное")</dd>

                        <dt class="col-sm-4">Название:</dt>
                        <dd class="col-sm-8">@Model.Title</dd>

                        <dt class="col-sm-4">Тренер:</dt>
                        <dd class="col-sm-8">@(Model.Trainer?.FullName ?? "Не назначен")</dd>

                        <dt class="col-sm-4">Зал:</dt>
                        <dd class="col-sm-8">@(Model.Hall ?? "Не указан")</dd>

                        <dt class="col-sm-4">Время начала:</dt>
                        <dd class="col-sm-8">@Model.StartTime.ToString("dd.MM.yyyy HH:mm")</dd>

                        <dt class="col-sm-4">Время окончания:</dt>
                        <dd class="col-sm-8">@Model.EndTime.ToString("dd.MM.yyyy HH:mm")</dd>

                        <dt class="col-sm-4">Макс. участников:</dt>
                        <dd class="col-sm-8">@(Model.MaxParticipants?.ToString() ?? "Не ограничено")</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Записанные клиенты</h5>
                </div>
                <div class="card-body">
                    @if (Model.Registrations.Any())
                    {
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Клиент</th>
                                    <th>Посетил</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var registration in Model.Registrations)
                                {
                                    <tr>
                                        <td>@registration.Client.FullName</td>
                                        <td>
                                            <input type="checkbox" class="form-check-input attendance-checkbox" 
                                                   data-registration-id="@registration.RegistrationId"
                                                   @(registration.Attended ? "checked" : "") />
                                        </td>
                                        <td>
                                            @if (User.IsInRole("Admin"))
                                            {
                                                <button class="btn btn-sm btn-danger remove-client-btn" 
                                                        data-registration-id="@registration.RegistrationId">Удалить</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">Нет записанных клиентов</p>
                    }
                    @if (User.IsInRole("Admin"))
                    {
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addClientModal">Добавить клиента</button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">Назад к расписанию</a>
        @if (User.IsInRole("Admin"))
        {
            <a asp-action="Edit" asp-route-id="@Model.ClassId" class="btn btn-warning">Редактировать</a>
            <a asp-action="Delete" asp-route-id="@Model.ClassId" class="btn btn-danger">Удалить</a>
        }
    </div>
</div>

<!-- Модальное окно для добавления клиента -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить клиента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select id="clientSelect" class="form-select">
                    <option value="">Выберите клиента</option>
                    <!-- Загружается через AJAX -->
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addClientToClass()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Загрузка списка клиентов при открытии модального окна
    $('#addClientModal').on('show.bs.modal', function() {
        fetch('/Clients/GetAll')
            .then(response => response.json())
            .then(data => {
                var select = document.getElementById('clientSelect');
                select.innerHTML = '<option value="">Выберите клиента</option>';
                data.forEach(function(client) {
                    var option = document.createElement('option');
                    option.value = client.clientId;
                    option.text = client.fullName;
                    select.appendChild(option);
                });
            });
    });

    function addClientToClass() {
        var clientId = document.getElementById('clientSelect').value;
        if (!clientId) {
            alert('Выберите клиента');
            return;
        }

        fetch('/Schedule/RegisterClient', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classId: @Model.ClassId,
                clientId: parseInt(clientId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Ошибка при добавлении клиента');
            }
        });
    }

    // Отметка посещения
    $('.attendance-checkbox').on('change', function() {
        var registrationId = $(this).data('registration-id');
        var attended = $(this).is(':checked');

        fetch('/Schedule/MarkAttendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                registrationId: registrationId,
                attended: attended
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert(data.message || 'Ошибка при обновлении посещения');
                $(this).prop('checked', !attended);
            }
        });
    });
</script>

